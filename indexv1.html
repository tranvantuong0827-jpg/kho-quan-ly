<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS Pro Mobile - V≈©ng T√†u Aquarium</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { --ban-hang: #28a745; --nhap-hang: #007bff; --tra-hang: #dc3545; }
        body { background: #f0f2f5; font-family: -apple-system, sans-serif; }
        .hidden { display: none; }
        
        /* Giao di·ªán Mobile t·ªëi ∆∞u */
        .order-row { 
            background: #fff; padding: 15px; border-radius: 12px; 
            margin-bottom: 10px; border-left: 8px solid #ccc;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .ban-hang-theme { border-left-color: var(--ban-hang) !important; }
        .nhap-hang-theme { border-left-color: var(--nhap-hang) !important; }
        .tra-hang-theme { border-left-color: var(--tra-hang) !important; }

        .btn-lg-mobile { padding: 12px; font-weight: bold; border-radius: 10px; }
        .price-text { color: #666; font-size: 0.9rem; }
        
        /* Header & Sidebar */
        .header-pos { background: #fff; padding: 12px; border-bottom: 1px solid #ddd; }
        .sidebar-btn { 
            width: 100%; text-align: left; padding: 18px 25px; 
            border: none; background: none; border-bottom: 1px solid #f0f0f0; 
            font-size: 1.1rem;
        }

        /* Dashboad Alert */
        .alert-card { background: #fff; border-radius: 15px; padding: 15px; margin-bottom: 15px; }
    </style>
</head>
<body>

<div class="container-fluid p-0">
    <div id="login-box" class="container py-5">
        <div class="row justify-content-center">
            <div class="col-11 col-md-4 card p-4 text-center shadow-lg border-0" style="border-radius: 20px;">
                <h3 class="fw-bold text-primary mb-4">POS AQUARIUM</h3>
                <input type="text" id="u" class="form-control mb-3 py-3" placeholder="T√†i kho·∫£n">
                <input type="password" id="p" class="form-control mb-3 py-3" placeholder="M·∫≠t kh·∫©u">
                <div class="form-check text-start mb-4">
                    <input class="form-check-input" type="checkbox" id="remember">
                    <label class="form-check-label small" for="remember">Ghi nh·ªõ ƒëƒÉng nh·∫≠p</label>
                </div>
                <button onclick="login()" class="btn btn-primary w-100 py-3 fw-bold rounded-pill">ƒêƒÇNG NH·∫¨P</button>
                <div id="auto-login-area" class="hidden mt-3">
                    <button onclick="autoLoginPrompt()" class="btn btn-light btn-sm w-100">D√πng t√†i kho·∫£n ƒë√£ l∆∞u</button>
                </div>
            </div>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <div class="header-pos d-flex justify-content-between align-items-center sticky-top">
            <div class="d-flex align-items-center">
                <button class="fs-3 border-0 bg-transparent me-2" data-bs-toggle="offcanvas" data-bs-target="#menu">‚ò∞</button>
                <div>
                    <div class="small text-muted">Ch√†o, <b id="u-display"></b></div>
                    <div id="clock-header" style="font-size: 0.75rem; font-weight: bold; color: #0d6efd;"></div>
                </div>
            </div>
            <button onclick="location.reload()" class="btn btn-outline-danger btn-sm">Tho√°t</button>
        </div>

        <div class="p-3" id="main-content">
            <div id="dashboard">
                <div class="alert-card shadow-sm border-start border-danger border-4">
                    <h6 class="fw-bold text-danger mb-3">üî• C·∫¢NH B√ÅO H·∫æT H√ÄNG</h6>
                    <div id="low-stock-list">ƒêang ki·ªÉm tra...</div>
                </div>
                <div class="text-center text-muted mt-5 px-4">
                    <p>B·∫•m menu ‚ò∞ ƒë·ªÉ ch·ªçn nghi·ªáp v·ª• B√°n ho·∫∑c Nh·∫≠p h√†ng.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="offcanvas offcanvas-start" tabindex="-1" id="menu" style="width: 280px;">
    <div class="offcanvas-header bg-dark text-white">
        <h5 class="offcanvas-title fw-bold">DANH M·ª§C</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body p-0">
        <button class="sidebar-btn" onclick="openTab('ban-hang')">üõçÔ∏è B√°n H√†ng (Xu·∫•t)</button>
        <button class="sidebar-btn" onclick="openTab('nhap-hang')">üì¶ Nh·∫≠p H√†ng (C·ªông)</button>
        <button class="sidebar-btn text-danger fw-bold" onclick="openTab('tra-hang')">‚Ü©Ô∏è Kh√°ch Tr·∫£ H√†ng</button>
        <button class="sidebar-btn" onclick="openTab('lich-su')">üìú Nh·∫≠t K√Ω & X√≥a ƒê∆°n</button>
        <button class="sidebar-btn" onclick="openTab('bao-cao-kho')">üìä Xem B√°o C√°o Kho</button>
        <button id="admin-btn" class="sidebar-btn bg-warning-subtle text-danger fw-bold hidden" onclick="openTab('loi-nhuan')">üí∞ T√†i Ch√≠nh & L√£i</button>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx7quu8A47WBW2w4XWC3_sqDwez-E8FwB6UUigNGjBDAWFl9_lyp0MHSv2VRMF9a14TTQ/exec";
    let currentUser = "", currentRole = "", productList = [];

    window.onload = () => {
        const saved = localStorage.getItem('pos_user');
        if(saved) {
            document.getElementById('auto-login-area').classList.remove('hidden');
            document.getElementById('u').value = saved;
        }
        updateTime(); setInterval(updateTime, 1000);
    };

    function updateTime() {
        const n = new Date();
        const s = n.getHours().toString().padStart(2,'0') + ":" + n.getMinutes().toString().padStart(2,'0') + ":" + n.getSeconds().toString().padStart(2,'0');
        if(document.getElementById('clock-header')) document.getElementById('clock-header').innerText = s;
    }

    async function login() {
        const u = document.getElementById('u').value, p = document.getElementById('p').value;
        Swal.fire({title: 'ƒêang ƒëƒÉng nh·∫≠p...', didOpen: () => Swal.showLoading()});
        try {
            const r = await fetch(`${SCRIPT_URL}?action=login`, {method: 'POST', body: JSON.stringify({u, p})}).then(res => res.json());
            if(r.status === 'success') {
                if(document.getElementById('remember').checked) localStorage.setItem('pos_user', u);
                currentUser = u; currentRole = r.role;
                initApp(); Swal.close();
            } else { Swal.fire('L·ªói', 'Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u', 'error'); }
        } catch(e) { Swal.fire('L·ªói k·∫øt n·ªëi', '', 'error'); }
    }

    function autoLoginPrompt() { Swal.fire('Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u', '', 'info').then(() => document.getElementById('p').focus()); }

    async function initApp() {
        document.getElementById('login-box').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
        document.getElementById('u-display').innerText = currentUser;
        if(currentRole === 'admin') document.getElementById('admin-btn').classList.remove('hidden');
        await refreshData();
    }

    async function refreshData() {
        productList = await fetch(`${SCRIPT_URL}?action=getProducts`).then(r => r.json());
        renderAlerts();
    }

    function renderAlerts() {
        const low = productList.filter(p => p.ton_kho < 5);
        document.getElementById('low-stock-list').innerHTML = low.length ? 
            low.map(p => `<div class="d-flex justify-content-between border-bottom py-2"><span>${p.ten}</span><b class="text-danger">${p.ton_kho}</b></div>`).join('') : 
            "<p class='text-success small m-0'>ƒê·∫ßy ƒë·ªß h√†ng</p>";
    }

    function openTab(name) {
        bootstrap.Offcanvas.getInstance(document.getElementById('menu')).hide();
        const content = document.getElementById('main-content');
        
        if(['ban-hang', 'nhap-hang', 'tra-hang'].includes(name)) {
            const type = name === 'ban-hang' ? "B√°n h√†ng" : (name === 'nhap-hang' ? "Nh·∫≠p h√†ng" : "Kh√°ch tr·∫£ h√†ng");
            const theme = name === 'ban-hang' ? "ban-hang-theme" : (name === 'nhap-hang' ? "nhap-hang-theme" : "tra-hang-theme");
            const btnColor = name === 'ban-hang' ? "btn-success" : (name === 'nhap-hang' ? "btn-primary" : "btn-danger");
            
            content.innerHTML = `<h4 class="fw-bold mb-3">${type}</h4>
                <div id="items-list"></div>
                <button onclick="addRow('${theme}')" class="btn btn-outline-secondary w-100 mb-4 py-2">+ Th√™m s·∫£n ph·∫©m</button>
                <div class="card p-3 shadow-sm border-0 mb-5" style="border-radius:15px; background: #fff;">
                    <div class="mb-3">
                        <label class="small fw-bold mb-2">H√¨nh th·ª©c:</label>
                        <select id="p-method" class="form-select form-select-lg">
                            <option value="Ti·ªÅn m·∫∑t">üíµ Ti·ªÅn m·∫∑t</option>
                            <option value="Chuy·ªÉn kho·∫£n">üè¶ Chuy·ªÉn kho·∫£n (Bank)</option>
                        </select>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="fw-bold">T·ªîNG C·ªòNG:</span>
                        <span id="total-bill" class="fs-3 fw-bold text-danger">0</span>
                    </div>
                    <button onclick="submitOrder('${type}')" class="btn ${btnColor} w-100 py-3 fw-bold rounded-pill">X√ÅC NH·∫¨N L∆ØU</button>
                </div>`;
            addRow(theme);
        } else if(name === 'lich-su') { renderHistory(); }
        else if(name === 'bao-cao-kho') { renderStock(); }
        else if(name === 'loi-nhuan') { renderProfit(); }
    }

    function addRow(theme) {
        const id = Date.now();
        const row = `<div class="order-row ${theme} row g-1" id="row-${id}">
            <div class="col-12 mb-2"><input list="plist" onchange="updateRow(${id}, this.value)" class="form-control form-control-lg" placeholder="Ch·ªçn t√™n c√°/m·ªìi..."></div>
            <div class="col-4"><input type="number" id="q-${id}" onchange="calc()" class="form-control form-control-lg text-center" value="1"></div>
            <div class="col-6 text-end pt-1"><div class="price-text" id="unit-${id}">0 ƒë</div><b class="fs-5" id="p-${id}">0</b></div>
            <div class="col-2 text-center"><button onclick="this.parentElement.parentElement.remove();calc()" class="btn btn-link text-danger fs-4 mt-1">‚úï</button></div>
        </div>`;
        document.getElementById('items-list').insertAdjacentHTML('beforeend', row);
        updateDatalist();
    }

    function updateRow(id, val) {
        const p = productList.find(x => x.ten === val);
        if(p) {
            document.getElementById(`unit-${id}`).innerText = p.gia_ban.toLocaleString() + " ƒë";
            document.getElementById(`p-${id}`).innerText = p.gia_ban;
            calc();
        }
    }

    function calc() {
        let t = 0;
        document.querySelectorAll('.order-row').forEach(r => {
            const id = r.id.split('-')[1];
            t += Number(document.getElementById(`p-${id}`).innerText) * Number(document.getElementById(`q-${id}`).value);
        });
        document.getElementById('total-bill').innerText = t.toLocaleString();
    }

    async function submitOrder(type) {
        const method = document.getElementById('p-method').value;
        const items = [];
        document.querySelectorAll('.order-row').forEach(r => {
            const id = r.id.split('-')[1], ten = r.querySelector('input').value, sl = Number(document.getElementById(`q-${id}`).value);
            if(ten) items.push({ten, sl, gia: Number(document.getElementById(`p-${id}`).innerText)});
        });
        if(!items.length) return;
        
        Swal.fire({title: 'ƒêang l∆∞u...', allowOutsideClick: false, didOpen: () => Swal.showLoading()});
        await fetch(`${SCRIPT_URL}?action=saveOrder`, {method: 'POST', body: JSON.stringify({user: currentUser, type, method, items})});
        await refreshData();
        Swal.fire('Th√†nh c√¥ng', '', 'success');
        openTab(type === 'B√°n h√†ng' ? 'ban-hang' : (type === 'Nh·∫≠p h√†ng' ? 'nhap-hang' : 'tra-hang'));
    }

    async function renderHistory() {
        const h = await fetch(`${SCRIPT_URL}?action=getHistory`).then(r => r.json());
        let html = `<h4 class="fw-bold mb-3">üìú Nh·∫≠t k√Ω</h4>`;
        h.reverse().slice(0,15).forEach((x, i) => {
            html += `<div class="card p-3 mb-2 border-0 shadow-sm small">
                <div class="d-flex justify-content-between"><b>${x.madon}</b> <span>${x.pt_thanhtoan}</span></div>
                <div class="text-primary">${x.ten_sp} (x${x.sl})</div>
                <div class="d-flex justify-content-between mt-1"><span>${new Date(x.thoigian).toLocaleTimeString()}</span> <b class="text-danger">${Number(x.thanhtien).toLocaleString()} ƒë</b></div>
            </div>`;
        });
        document.getElementById('main-content').innerHTML = html;
    }

    function renderStock() {
        let html = `<h4 class="fw-bold mb-3">üìä T·ªìn kho</h4><input type="text" class="form-control mb-3" placeholder="T√¨m ki·∫øm..." onkeyup="filter(this.value)">
            <div id="s-list">` + productList.map(p => `<div class="card p-2 mb-1 border-0 shadow-sm d-flex flex-row justify-content-between">
                <span>${p.ten}</span><b class="${p.ton_kho < 5 ? 'text-danger' : ''}">${p.ton_kho}</b>
            </div>`).join('') + `</div>`;
        document.getElementById('main-content').innerHTML = html;
    }

    function filter(v) {
        document.querySelectorAll('#s-list .card').forEach(c => {
            c.style.display = c.innerText.toLowerCase().includes(v.toLowerCase()) ? "flex" : "none";
        });
    }

    function updateDatalist() {
        let d = document.getElementById('plist') || document.createElement('datalist');
        d.id = 'plist'; d.innerHTML = productList.map(p => `<option value="${p.ten}">`).join('');
        document.body.appendChild(d);
    }
</script>
</body>
</html>
