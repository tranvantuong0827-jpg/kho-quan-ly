<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS Master - Há»‡ Thá»‘ng Quáº£n LÃ½ Kho</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .hidden { display: none; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .sidebar-btn { width: 100%; text-align: left; padding: 15px; border: none; background: none; border-bottom: 1px solid #eee; transition: 0.2s; }
        .sidebar-btn:hover { background: #e7f3ff; color: #0d6efd; }
        .order-row { background: #fff; padding: 10px; border-radius: 8px; margin-bottom: 8px; border-left: 5px solid #0d6efd; }
    </style>
</head>
<body>

<div class="container py-4">
    <div id="login-box" class="row justify-content-center mt-5">
        <div class="col-md-4 card p-4 text-center">
            <h3 class="text-primary fw-bold mb-4">Há»† THá»NG POS</h3>
            <input type="text" id="u" class="form-control mb-2" placeholder="TÃªn Ä‘Äƒng nháº­p">
            <input type="password" id="p" class="form-control mb-4" placeholder="Máº­t kháº©u">
            <button onclick="login()" class="btn btn-primary w-100 py-2 fw-bold">VÃ€O Há»† THá»NG</button>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <header class="d-flex justify-content-between align-items-center mb-4 bg-white p-3 rounded shadow-sm">
            <span>ğŸ‘¤ NhÃ¢n viÃªn: <b id="u-display"></b></span>
            <button onclick="location.reload()" class="btn btn-outline-danger btn-sm">ÄÄƒng xuáº¥t</button>
        </header>

        <div class="row">
            <div class="col-md-3 mb-3">
                <div class="card shadow-sm overflow-hidden">
                    <button class="sidebar-btn" onclick="showTab('ban-hang')">ğŸ›ï¸ BÃ¡n HÃ ng (Xuáº¥t)</button>
                    <button class="sidebar-btn" onclick="showTab('nhap-hang')">ğŸ“¦ Nháº­p HÃ ng (Cá»™ng)</button>
                    <button class="sidebar-btn text-danger fw-bold" onclick="showTab('tra-hang')">â†©ï¸ KhÃ¡ch Tráº£ HÃ ng</button>
                    <button class="sidebar-btn" onclick="showTab('lich-su')">ğŸ“œ Nháº­t KÃ½ & XÃ³a ÄÆ¡n</button>
                    <button id="admin-btn" class="sidebar-btn bg-warning-subtle text-danger fw-bold hidden" onclick="showTab('loi-nhuan')">ğŸ“Š TÃ i ChÃ­nh & Lá»£i Nhuáº­n</button>
                </div>
            </div>
            <div class="col-md-9">
                <div id="content" class="card p-4 min-vh-50">
                    <div class="text-center py-5 text-muted">Vui lÃ²ng chá»n chá»©c nÄƒng Ä‘á»ƒ báº¯t Ä‘áº§u</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // URL Apps Script cá»§a báº¡n
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx7quu8A47WBW2w4XWC3_sqDwez-E8FwB6UUigNGjBDAWFl9_lyp0MHSv2VRMF9a14TTQ/exec";
    let currentUser = "", currentRole = "", productList = [];

    async function login() {
        const u = document.getElementById('u').value, p = document.getElementById('p').value;
        Swal.showLoading();
        const res = await fetch(`${SCRIPT_URL}?action=login`, { method: 'POST', body: JSON.stringify({u, p}) }).then(r => r.json());
        Swal.close();
        if(res.status === 'success') {
            currentUser = u; currentRole = res.role;
            document.getElementById('login-box').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('u-display').innerText = u;
            if(res.role === 'admin') document.getElementById('admin-btn').classList.remove('hidden');
            await loadProducts();
            showStockAlert();
        } else { Swal.fire('Lá»—i', 'Sai thÃ´ng tin Ä‘Äƒng nháº­p!', 'error'); }
    }

    async function loadProducts() { productList = await fetch(`${SCRIPT_URL}?action=getProducts`).then(r => r.json()); }

    function showTab(name) {
        if(['ban-hang', 'nhap-hang', 'tra-hang'].includes(name)) {
            let type = name === 'ban-hang' ? "BÃ¡n hÃ ng" : (name === 'nhap-hang' ? "Nháº­p hÃ ng" : "KhÃ¡ch tráº£ hÃ ng");
            document.getElementById('content').innerHTML = `<h4>${type}</h4>
                <div id="items-list"></div>
                <button onclick="addRow()" class="btn btn-outline-primary btn-sm mb-3">+ ThÃªm MÃ³n</button>
                <div class="p-3 bg-light rounded shadow-sm">
                    <div class="mb-3">
                        <label class="fw-bold mb-2 d-block">HÃ¬nh thá»©c thanh toÃ¡n:</label>
                        <div class="btn-group w-100">
                            <input type="radio" class="btn-check" name="method" id="m1" value="Tiá»n máº·t" checked>
                            <label class="btn btn-outline-secondary" for="m1">ğŸ’µ Tiá»n máº·t</label>
                            <input type="radio" class="btn-check" name="method" id="m2" value="Chuyá»ƒn khoáº£n">
                            <label class="btn btn-outline-secondary" for="m2">ğŸ¦ Bank</label>
                        </div>
                    </div>
                    <h5 class="text-end">Tá»•ng tiá»n: <span id="total-bill" class="text-danger fw-bold">0</span> Ä‘</h5>
                    <button onclick="sendOrder('${type}')" class="btn btn-primary w-100 btn-lg mt-2 fw-bold">XÃC NHáº¬N GIAO Dá»ŠCH</button>
                </div>`;
            addRow();
        } else if(name === 'lich-su') { loadHistory(); }
        else if(name === 'loi-nhuan') { loadFinanceReport(); }
    }

    function addRow() {
        const id = Date.now();
        const row = `<div class="order-row row g-2" id="row-${id}">
            <div class="col-6"><input list="plist" onchange="updateRow(${id}, this.value)" class="form-control" placeholder="TÃªn sáº£n pháº©m..."></div>
            <div class="col-2"><input type="number" id="q-${id}" onchange="calcTotal()" class="form-control text-center" value="1" min="1"></div>
            <div class="col-3 text-end"><b id="p-${id}">0</b> <div class="text-muted small" id="s-${id}"></div></div>
            <div class="col-1 text-center"><button onclick="this.parentElement.parentElement.remove();calcTotal()" class="btn text-danger">âœ•</button></div>
        </div>`;
        document.getElementById('items-list').insertAdjacentHTML('beforeend', row);
        updateDataList();
    }

    function updateRow(id, val) {
        const p = productList.find(x => x.ten === val);
        if(p) { document.getElementById(`p-${id}`).innerText = p.gia_ban; document.getElementById(`s-${id}`).innerText = `Kho: ${p.ton_kho}`; calcTotal(); }
    }

    function calcTotal() {
        let t = 0;
        document.querySelectorAll('.order-row').forEach(r => {
            const id = r.id.split('-')[1];
            t += Number(document.getElementById(`p-${id}`).innerText) * Number(document.getElementById(`q-${id}`).value);
        });
        document.getElementById('total-bill').innerText = t.toLocaleString();
    }

    async function sendOrder(type) {
        const method = document.querySelector('input[name="method"]:checked').value;
        const rawItems = {};
        document.querySelectorAll('.order-row').forEach(r => {
            const id = r.id.split('-')[1], ten = r.querySelector('input').value.trim(), sl = Number(document.getElementById(`q-${id}`).value);
            const sp = productList.find(x => x.ten === ten);
            if(sp) {
                if(rawItems[ten]) rawItems[ten].sl += sl;
                else rawItems[ten] = { ten, sl, gia: Number(document.getElementById(`p-${id}`).innerText), ton: sp.ton_kho };
            }
        });

        const items = Object.values(rawItems);
        if(items.length === 0) return Swal.fire("Lá»—i", "HÃ£y nháº­p sáº£n pháº©m!", "warning");

        // Kiá»ƒm tra tá»“n kho
        for(let it of items) {
            if(type === "BÃ¡n hÃ ng" && it.sl > it.ton) return Swal.fire("Háº¿t hÃ ng", `${it.ten} chá»‰ cÃ²n ${it.ton} mÃ³n!`, "error");
        }

        const confirm = await Swal.fire({ title: 'XÃ¡c nháº­n Ä‘Æ¡n?', icon: 'question', showCancelButton: true, confirmButtonText: 'LÆ°u Ä‘Æ¡n' });
        if(confirm.isConfirmed) {
            Swal.showLoading();
            await fetch(`${SCRIPT_URL}?action=saveOrder`, { method: 'POST', body: JSON.stringify({user: currentUser, type, method, items}) });
            Swal.fire('ThÃ nh cÃ´ng', '', 'success');
            showTab(type === 'BÃ¡n hÃ ng' ? 'ban-hang' : (type === 'Nháº­p hÃ ng' ? 'nhap-hang' : 'tra-hang')); loadProducts();
        }
    }

    async function loadFinanceReport() {
        if(currentRole !== 'admin') return;
        document.getElementById('content').innerHTML = "Äang tÃ­nh toÃ¡n...";
        const hist = await fetch(`${SCRIPT_URL}?action=getHistory`).then(r => r.json());
        let dCash = 0, dBank = 0, mProfit = 0;
        const now = new Date();
        hist.forEach(x => {
            const d = new Date(x.thoigian);
            if(d.toDateString() === now.toDateString()) {
                if(x.pt_thanhtoan === "Tiá»n máº·t") dCash += Number(x.thanhtien);
                else dBank += Number(x.thanhtien);
            }
            if(d.getMonth() === now.getMonth()) mProfit += Number(x.loi_nhuan);
        });
        document.getElementById('content').innerHTML = `<h4>ğŸ“Š TÃ i ChÃ­nh</h4>
            <div class="row g-2 mb-3">
                <div class="col-6"><div class="card p-3 bg-primary text-white">HÃ´m nay (Máº·t):<br><b>${dCash.toLocaleString()}</b></div></div>
                <div class="col-6"><div class="card p-3 bg-info text-white">HÃ´m nay (Bank):<br><b>${dBank.toLocaleString()}</b></div></div>
            </div>
            <div class="card p-3 bg-success text-white text-center"><h5>Æ¯á»šC TÃNH LÃƒI THÃNG NÃ€Y: ${mProfit.toLocaleString()} Ä‘</h5></div>`;
    }

    async function loadHistory() {
        const hist = await fetch(`${SCRIPT_URL}?action=getHistory`).then(r => r.json());
        let h = `<h4>ğŸ“œ Nháº­t KÃ½</h4><table class="table table-sm table-hover"><thead><tr><th>ÄÆ¡n</th><th>MÃ³n</th><th>SL</th><th>PT</th><th></th></tr></thead><tbody>`;
        hist.reverse().slice(0, 20).forEach((x, i) => {
            h += `<tr><td><small>${x.madon}</small></td><td>${x.ten_sp}</td><td>${x.sl}</td><td>${x.pt_thanhtoan}</td>
            <td><button onclick="deleteRow(${hist.length - i})" class="btn text-danger p-0">ğŸ—‘ï¸</button></td></tr>`;
        });
        document.getElementById('content').innerHTML = h + `</tbody></table>`;
    }

    async function deleteRow(idx) {
        const res = await Swal.fire({ title: 'XÃ³a vÃ  HoÃ n kho?', icon: 'warning', showCancelButton: true });
        if(res.isConfirmed) {
            Swal.showLoading();
            await fetch(`${SCRIPT_URL}?action=deleteOrder`, { method: 'POST', body: JSON.stringify({row: idx + 1}) });
            loadHistory(); loadProducts(); Swal.close();
        }
    }

    function showStockAlert() {
        let list = "";
        productList.forEach(p => { 
            const color = p.ton_kho < 5 ? "text-danger fw-bold" : "";
            list += `<div class="d-flex justify-content-between border-bottom py-1 ${color}"><span>${p.ten}</span><span>${p.ton_kho}</span></div>`;
        });
        Swal.fire({ title: 'Tá»“n kho hiá»‡n táº¡i', html: `<div class="text-start" style="font-size:0.9rem">${list}</div>`, confirmButtonText: 'ÄÃ£ hiá»ƒu' });
    }

    function updateDataList() {
        let dl = document.getElementById('plist') || document.createElement('datalist');
        dl.id = 'plist'; dl.innerHTML = productList.map(p => `<option value="${p.ten}">`).join('');
        document.body.appendChild(dl);
    }
</script>
</body>
</html>
