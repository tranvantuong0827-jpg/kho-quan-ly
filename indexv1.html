<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS Pro Max v8 - V≈©ng T√†u Aquarium</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { --ban: #28a745; --nhap: #007bff; --tra: #dc3545; --tai-chinh: #6c757d; }
        body { background: #f0f2f5; font-family: -apple-system, sans-serif; overflow-x: hidden; }
        .hidden { display: none; }
        .offcanvas { width: 240px !important; }
        .sidebar-item { padding: 12px 20px; border: none; background: none; width: 100%; text-align: left; border-bottom: 1px solid #f1f1f1; font-size: 0.95rem; display: flex; align-items: center; }
        .sidebar-item:hover { background: #f8f9fa; color: var(--nhap); }
        .order-row { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 8px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .ban-theme { border-left-color: var(--ban) !important; }
        .nhap-theme { border-left-color: var(--nhap) !important; }
        .tra-theme { border-left-color: var(--tra) !important; }
        .bg-grey-pos { background-color: var(--tai-chinh) !important; color: white !important; }
        .stat-card { background: #fff; border-radius: 15px; padding: 15px; border-top: 4px solid var(--tai-chinh); }
        .stat-val { font-size: 1.1rem; font-weight: bold; }
        .stock-info { font-size: 0.85rem; color: #777; font-weight: bold; }
    </style>
</head>
<body>

<div class="container-fluid p-0">
    <div id="login-box" class="container py-5">
        <div class="row justify-content-center">
            <div class="col-11 col-md-4 card p-4 text-center shadow-lg border-0" style="border-radius: 20px;">
                <h3 class="fw-bold text-primary mb-4">POS AQUARIUM</h3>
                <input type="text" id="u" class="form-control mb-3 py-3" placeholder="T√†i kho·∫£n">
                <input type="password" id="p" class="form-control mb-3 py-3" placeholder="M·∫≠t kh·∫©u">
                <button onclick="login()" id="btn-login" class="btn btn-primary w-100 py-3 fw-bold rounded-pill shadow">ƒêƒÇNG NH·∫¨P</button>
            </div>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <div class="bg-white p-3 d-flex justify-content-between align-items-center sticky-top shadow-sm">
            <div class="d-flex align-items-center">
                <button class="fs-4 border-0 bg-transparent me-2" data-bs-toggle="offcanvas" data-bs-target="#menu">‚ò∞</button>
                <span class="small">Ch√†o, <b id="u-display"></b></span>
            </div>
            <div id="clock-header" class="fw-bold text-primary small"></div>
        </div>

        <div class="p-3" id="main-content">
            <div id="dashboard">
                <div class="card p-4 text-center shadow-sm border-0" style="border-radius: 20px;">
                    <h5 id="date-now" class="text-muted mb-3"></h5>
                    <div class="alert alert-danger py-2 px-3 small fw-bold rounded-pill">üî• KHO S·∫ÆP H·∫æT: <span id="low-count">0</span> m√≥n</div>
                    <div id="low-stock-list" class="text-start mt-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="offcanvas offcanvas-start" tabindex="-1" id="menu">
    <div class="offcanvas-header bg-dark text-white py-3">
        <h6 class="offcanvas-title fw-bold">MENU QU·∫¢N L√ù</h6>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body p-0">
        <button class="sidebar-item" onclick="openTab('ban-hang')">üõçÔ∏è B√°n H√†ng</button>
        <button class="sidebar-item" onclick="openTab('nhap-hang')">üì¶ Nh·∫≠p H√†ng</button>
        <button class="sidebar-item text-danger fw-bold" onclick="openTab('tra-hang')">‚Ü©Ô∏è Tr·∫£ H√†ng</button>
        <button class="sidebar-item" onclick="openTab('lich-su')">üìú Nh·∫≠t K√Ω</button>
        <button class="sidebar-item" onclick="openTab('bao-cao-kho')">üìä B√°o C√°o Kho</button>
        <button id="admin-btn-menu" class="sidebar-item bg-grey-pos fw-bold hidden" onclick="openTab('loi-nhuan')">üí∞ T√†i Ch√≠nh & L√£i</button>
        <div class="p-3 mt-4 border-top"><button onclick="location.reload()" class="btn btn-outline-secondary btn-sm w-100 rounded-pill">ƒêƒÉng xu·∫•t</button></div>
    </div>
</div>

<script>
    // URL M·ªöI C·ª¶A B·∫†N
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzTyeYHqaNEHDHlFJKpzViAsvcueUtFRWB0flhW9i78yeHGzcnjL3eWRVsKCH1VJiPd/exec";
    let currentUser = "", currentRole = "", productList = [], historyData = [];

    function fM(n) { return Number(n).toLocaleString('vi-VN') + " ƒë"; }

    window.onload = () => {
        if(localStorage.getItem('pos_user')) document.getElementById('u').value = localStorage.getItem('pos_user');
        setInterval(() => {
            const n = new Date();
            document.getElementById('clock-header').innerText = n.toLocaleTimeString('vi-VN');
            if(document.getElementById('date-now')) document.getElementById('date-now').innerText = n.toLocaleDateString('vi-VN', {weekday:'long', year:'numeric', month:'long', day:'numeric'});
        }, 1000);
    };

    async function login() {
        const u = document.getElementById('u').value, p = document.getElementById('p').value;
        const btn = document.getElementById('btn-login');
        btn.disabled = true; btn.innerText = "ƒêang x√°c th·ª±c...";
        try {
            const r = await fetch(`${SCRIPT_URL}?action=login`, {method: 'POST', body: JSON.stringify({u, p})}).then(res => res.json());
            if(r.status === 'success') {
                localStorage.setItem('pos_user', u);
                currentUser = u; currentRole = r.role;
                document.getElementById('login-box').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('u-display').innerText = currentUser;
                if(currentRole === 'admin') document.getElementById('admin-btn-menu').classList.remove('hidden');
                await Promise.all([refreshProducts(), refreshHistory()]);
            } else { Swal.fire('L·ªói', 'Th√¥ng tin sai!', 'error'); btn.disabled = false; btn.innerText = "ƒêƒÇNG NH·∫¨P"; }
        } catch(e) { Swal.fire('L·ªói m·∫°ng', '', 'error'); btn.disabled = false; btn.innerText = "ƒêƒÇNG NH·∫¨P"; }
    }

    async function refreshProducts() {
        productList = await fetch(`${SCRIPT_URL}?action=getProducts`).then(r => r.json());
        const low = productList.filter(p => p.ton_kho < 5);
        document.getElementById('low-count').innerText = low.length;
        document.getElementById('low-stock-list').innerHTML = low.map(p => `<div class="d-flex justify-content-between border-bottom py-2 small"><span>${p.ten}</span><b class="text-danger">${p.ton_kho}</b></div>`).join('');
    }

    async function refreshHistory() { historyData = await fetch(`${SCRIPT_URL}?action=getHistory`).then(r => r.json()); }

    function openTab(name) {
        bootstrap.Offcanvas.getInstance(document.getElementById('menu')).hide();
        const content = document.getElementById('main-content');
        if(['ban-hang', 'nhap-hang', 'tra-hang'].includes(name)) {
            const type = name === 'ban-hang' ? "B√°n h√†ng" : (name === 'nhap-hang' ? "Nh·∫≠p h√†ng" : "Kh√°ch tr·∫£ h√†ng");
            const theme = name === 'ban-hang' ? "ban-theme" : (name === 'nhap-hang' ? "nhap-theme" : "tra-theme");
            
            content.innerHTML = `<h5 class="fw-bold mb-3">${type}</h5><div id="items-list"></div>
                <button onclick="addRow('${theme}', '${name}')" class="btn btn-outline-secondary w-100 mb-3 py-2">+ Th√™m m√≥n</button>
                <div class="card p-3 shadow-sm border-0" style="border-radius:15px;">
                    <select id="p-method" class="form-select mb-3"><option value="Ti·ªÅn m·∫∑t">üíµ Ti·ªÅn m·∫∑t</option><option value="Chuy·ªÉn kho·∫£n">üè¶ Chuy·ªÉn kho·∫£n</option></select>
                    <div class="d-flex justify-content-between mb-3 align-items-center">
                        <span class="fw-bold">${name==='nhap-hang' ? 'S·ªê M√ìN NH·∫¨P:' : 'T·ªîNG C·ªòNG:'}</span>
                        <span id="total-bill" class="fs-4 fw-bold text-danger">${name==='nhap-hang' ? '0' : '0 ƒë'}</span>
                    </div>
                    <button id="btn-submit" onclick="submitOrder('${type}')" class="btn btn-lg w-100 fw-bold rounded-pill ${name==='ban-hang'?'btn-success':(name==='nhap-hang'?'btn-primary':'btn-danger')} shadow-sm">X√ÅC NH·∫¨N ${type.toUpperCase()}</button>
                </div>`;
            addRow(theme, name);
        } else if(name === 'lich-su') { renderHistory(); }
        else if(name === 'bao-cao-kho') { renderStock(); }
        else if(name === 'loi-nhuan') { renderFinance(); }
    }

    function addRow(theme, tabName) {
        const id = Date.now();
        const row = `<div class="order-row ${theme} row g-1" id="row-${id}">
            <div class="col-12 mb-1"><input list="plist" onchange="updateRow(${id}, this.value, '${tabName}')" class="form-control" placeholder="T√™n sp..."></div>
            <div class="col-4"><input type="number" id="q-${id}" onchange="calc('${tabName}')" class="form-control text-center" value="1"></div>
            <div class="col-6 text-end pt-1">
                <div class="stock-info" id="s-${id}">Kho c√≤n: 0</div>
                <div class="price-display ${tabName==='nhap-hang'?'hidden':''}" id="p-disp-${id}">0 ƒë</div>
                <span id="p-raw-${id}" class="hidden">0</span>
            </div>
            <div class="col-2 text-center pt-1"><button onclick="this.parentElement.parentElement.remove();calc('${tabName}')" class="btn text-danger fs-5">‚úï</button></div>
        </div>`;
        document.getElementById('items-list').insertAdjacentHTML('beforeend', row);
        let d = document.getElementById('plist') || document.createElement('datalist');
        d.id = 'plist'; d.innerHTML = productList.map(p => `<option value="${p.ten}">`).join('');
        document.body.appendChild(d);
    }

    function updateRow(id, val, tabName) {
        const p = productList.find(x => x.ten === val);
        if(p) { 
            document.getElementById(`p-raw-${id}`).innerText = p.gia_ban; 
            if(tabName !== 'nhap-hang') document.getElementById(`p-disp-${id}`).innerText = fM(p.gia_ban);
            document.getElementById(`s-${id}`).innerText = "Kho c√≤n: " + p.ton_kho;
            calc(tabName); 
        }
    }

    function calc(tabName) {
        let t = 0;
        document.querySelectorAll('.order-row').forEach(r => {
            const id = r.id.split('-')[1];
            const q = Number(document.getElementById(`q-${id}`).value);
            if(tabName === 'nhap-hang') t += q;
            else t += Number(document.getElementById(`p-raw-${id}`).innerText) * q;
        });
        document.getElementById('total-bill').innerText = tabName === 'nhap-hang' ? t : fM(t);
    }

    async function submitOrder(type) {
        const items = [];
        document.querySelectorAll('.order-row').forEach(r => {
            const id = r.id.split('-')[1], ten = r.querySelector('input').value, sl = Number(document.getElementById(`q-${id}`).value);
            if(ten) items.push({ten, sl, gia: Number(document.getElementById(`p-raw-${id}`).innerText)});
        });
        if(!items.length) return;
        const btn = document.getElementById('btn-submit');
        btn.disabled = true; btn.innerHTML = "ƒêang l∆∞u...";
        try {
            await fetch(`${SCRIPT_URL}?action=saveOrder`, {method: 'POST', body: JSON.stringify({user: currentUser, type, method: document.getElementById('p-method').value, items})});
            Swal.fire({title: 'Xong!', icon: 'success', timer: 800, showConfirmButton: false});
            openTab(type === 'B√°n h√†ng' ? 'ban-hang' : (type === 'Nh·∫≠p h√†ng' ? 'nhap-hang' : 'tra-hang'));
            refreshProducts(); refreshHistory();
        } catch(e) { Swal.fire('L·ªói', 'Kh√¥ng l∆∞u ƒë∆∞·ª£c', 'error'); btn.disabled = false; }
    }

    function renderFinance() {
        const now = new Date();
        const todayStr = now.toLocaleDateString('vi-VN');
        let dRev = 0, dProfit = 0, dCost = 0;
        let mRev = 0, mProfit = 0, mCost = 0;
        
        historyData.forEach(x => {
            const d = new Date(x.thoigian);
            const amt = Number(x.thanhtien); 
            const l√£i = Number(x.loi_nhuan); 
            const chi = Number(x.chi_phi_nhap || 0);

            if(d.toLocaleDateString('vi-VN') === todayStr) { dRev += amt; dProfit += l√£i; dCost += chi; }
            if(d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear()) { mRev += amt; mProfit += l√£i; mCost += chi; }
        });

        document.getElementById('main-content').innerHTML = `<h5 class="fw-bold mb-3" style="color:var(--tai-chinh)">üí∞ TH·ªêNG K√ä T√ÄI CH√çNH (X√ÅM)</h5>
            <div class="row g-2">
                <div class="col-6"><div class="stat-card shadow-sm"><small>D.Thu ng√†y</small><div class="stat-val text-primary">${fM(dRev)}</div></div></div>
                <div class="col-6"><div class="stat-card shadow-sm"><small>Chi nh·∫≠p ng√†y</small><div class="stat-val text-danger">${fM(dCost)}</div></div></div>
                <div class="col-12"><div class="stat-card shadow-sm"><small>L√£i r√≤ng ng√†y</small><div class="stat-val text-success">${fM(dProfit)}</div></div></div>
                <div class="col-12 mt-2"><div class="stat-card shadow-sm"><small>Doanh thu th√°ng</small><div class="stat-val text-primary">${fM(mRev)}</div></div></div>
                <div class="col-12"><div class="stat-card shadow-sm"><small>T·ªïng chi nh·∫≠p th√°ng</small><div class="stat-val text-danger">${fM(mCost)}</div></div></div>
                <div class="col-12"><div class="stat-card shadow-sm"><small>L·ª£i nhu·∫≠n r√≤ng th√°ng</small><div class="stat-val text-success">${fM(mProfit)}</div></div></div>
            </div>`;
    }

    function renderHistory() {
        document.getElementById('main-content').innerHTML = `<h5 class="fw-bold mb-3">üìú Nh·∫≠t k√Ω ƒë∆°n h√†ng</h5>` + 
            [...historyData].reverse().slice(0,10).map(x => `<div class="card p-3 mb-2 border-0 shadow-sm small">
                <div class="d-flex justify-content-between mb-1"><b>${x.madon}</b> <span class="badge bg-light text-dark">${x.pt_thanhtoan}</span></div>
                <div class="text-primary">${x.ten_sp} (x${x.sl})</div>
                <div class="text-end fw-bold ${x.loi==='Nh·∫≠p h√†ng'?'text-muted':'text-danger'}">${x.loi==='Nh·∫≠p h√†ng'?'(Chi ph√≠ nh·∫≠p)':fM(x.thanhtien)}</div>
            </div>`).join('');
    }

    function renderStock() {
        document.getElementById('main-content').innerHTML = `<h5 class="fw-bold mb-3">üìä B√°o c√°o t·ªìn kho</h5>` + 
            productList.map(p => `<div class="card p-2 px-3 mb-1 border-0 shadow-sm d-flex flex-row justify-content-between align-items-center"><span>${p.ten}</span><b class="${p.ton_kho<5?'text-danger':''}">${p.ton_kho}</b></div>`).join('');
    }
</script>
</body>
</html>
