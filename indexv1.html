<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS Pro Max v3 - V≈©ng T√†u Aquarium</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { --ban: #28a745; --nhap: #007bff; --tra: #dc3545; --tai-chinh: #6c757d; }
        body { background: #f0f2f5; font-family: -apple-system, sans-serif; overflow-x: hidden; }
        .hidden { display: none; }
        .order-row { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 8px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .ban-theme { border-left-color: var(--ban) !important; }
        .nhap-theme { border-left-color: var(--nhap) !important; }
        .tra-theme { border-left-color: var(--tra) !important; }
        .bg-grey-pos { background-color: var(--tai-chinh) !important; color: white !important; }
        .stat-card { background: #fff; border-radius: 15px; padding: 15px; border-top: 4px solid var(--tai-chinh); }
        .stat-val { font-size: 1.2rem; font-weight: bold; }
        .stock-label { font-size: 0.8rem; color: #666; font-style: italic; }
    </style>
</head>
<body>

<div class="container-fluid p-0">
    <div id="login-box" class="container py-5">
        <div class="row justify-content-center">
            <div class="col-11 col-md-4 card p-4 text-center shadow-lg border-0" style="border-radius: 20px;">
                <h3 class="fw-bold text-primary mb-4">POS AQUARIUM</h3>
                <input type="text" id="u" class="form-control mb-3 py-3" placeholder="T√†i kho·∫£n">
                <input type="password" id="p" class="form-control mb-3 py-3" placeholder="M·∫≠t kh·∫©u">
                <button onclick="login()" class="btn btn-primary w-100 py-3 fw-bold rounded-pill">ƒêƒÇNG NH·∫¨P</button>
            </div>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <div class="bg-white p-3 d-flex justify-content-between align-items-center sticky-top shadow-sm">
            <div class="d-flex align-items-center">
                <button class="fs-3 border-0 bg-transparent me-2" data-bs-toggle="offcanvas" data-bs-target="#menu">‚ò∞</button>
                <b id="u-display"></b>
            </div>
            <div id="clock-header" class="fw-bold text-primary small"></div>
        </div>

        <div class="p-3" id="main-content">
            <div id="dashboard">
                <div class="card p-4 text-center shadow-sm border-0">
                    <h5 id="date-now" class="text-muted mb-3"></h5>
                    <div class="alert alert-danger py-2 px-3 small fw-bold">üî• KHO S·∫ÆP H·∫æT: <span id="low-count">0</span> m√≥n</div>
                    <div id="low-stock-list" class="text-start mt-2"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="offcanvas offcanvas-start" tabindex="-1" id="menu">
    <div class="offcanvas-header bg-dark text-white">
        <h5 class="offcanvas-title fw-bold">MENU</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body p-0">
        <button class="btn w-100 text-start p-3 border-bottom" onclick="openTab('ban-hang')">üõçÔ∏è B√°n H√†ng</button>
        <button class="btn w-100 text-start p-3 border-bottom" onclick="openTab('nhap-hang')">üì¶ Nh·∫≠p H√†ng</button>
        <button class="btn w-100 text-start p-3 border-bottom text-danger fw-bold" onclick="openTab('tra-hang')">‚Ü©Ô∏è Tr·∫£ H√†ng</button>
        <button class="btn w-100 text-start p-3 border-bottom" onclick="openTab('lich-su')">üìú Nh·∫≠t K√Ω</button>
        <button class="btn w-100 text-start p-3 border-bottom" onclick="openTab('bao-cao-kho')">üìä B√°o C√°o Kho</button>
        <button id="admin-btn" class="btn w-100 text-start p-3 bg-grey-pos fw-bold hidden" onclick="openTab('loi-nhuan')">üí∞ T√†i Ch√≠nh & L√£i</button>
        <button onclick="location.reload()" class="btn w-100 text-start p-3 text-muted">ƒêƒÉng xu·∫•t</button>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx7quu8A47WBW2w4XWC3_sqDwez-E8FwB6UUigNGjBDAWFl9_lyp0MHSv2VRMF9a14TTQ/exec";
    let currentUser = "", currentRole = "", productList = [], historyData = [];

    // ƒê·ªãnh d·∫°ng ti·ªÅn t·ªá 15.000ƒë
    function formatMoney(num) {
        return Number(num).toLocaleString('vi-VN') + " ƒë";
    }

    window.onload = () => {
        setInterval(() => {
            const n = new Date();
            document.getElementById('clock-header').innerText = n.toLocaleTimeString('vi-VN');
            if(document.getElementById('date-now')) document.getElementById('date-now').innerText = n.toLocaleDateString('vi-VN', {weekday:'long', year:'numeric', month:'long', day:'numeric'});
        }, 1000);
    };

    async function login() {
        const u = document.getElementById('u').value, p = document.getElementById('p').value;
        Swal.fire({title: 'ƒêang k·∫øt n·ªëi...', allowOutsideClick: false, didOpen: () => Swal.showLoading()});
        try {
            const r = await fetch(`${SCRIPT_URL}?action=login`, {method: 'POST', body: JSON.stringify({u, p})}).then(res => res.json());
            if(r.status === 'success') {
                currentUser = u; currentRole = r.role;
                document.getElementById('login-box').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('u-display').innerText = currentUser;
                if(currentRole === 'admin') document.getElementById('admin-btn').classList.remove('hidden');
                await Promise.all([refreshProducts(), refreshHistory()]);
                Swal.close();
            } else { Swal.fire('L·ªói', 'Sai th√¥ng tin', 'error'); }
        } catch(e) { Swal.fire('L·ªói m·∫°ng', 'Vui l√≤ng ki·ªÉm tra internet', 'error'); }
    }

    async function refreshProducts() {
        productList = await fetch(`${SCRIPT_URL}?action=getProducts`).then(r => r.json());
        const low = productList.filter(p => p.ton_kho < 5);
        document.getElementById('low-count').innerText = low.length;
        document.getElementById('low-stock-list').innerHTML = low.map(p => `<div class="d-flex justify-content-between border-bottom py-1 small"><span>${p.ten}</span><b class="text-danger">${p.ton_kho}</b></div>`).join('');
    }

    async function refreshHistory() {
        historyData = await fetch(`${SCRIPT_URL}?action=getHistory`).then(r => r.json());
    }

    function openTab(name) {
        bootstrap.Offcanvas.getInstance(document.getElementById('menu')).hide();
        const content = document.getElementById('main-content');
        if(['ban-hang', 'nhap-hang', 'tra-hang'].includes(name)) {
            const type = name === 'ban-hang' ? "B√°n h√†ng" : (name === 'nhap-hang' ? "Nh·∫≠p h√†ng" : "Kh√°ch tr·∫£ h√†ng");
            const theme = name === 'ban-hang' ? "ban-theme" : (name === 'nhap-hang' ? "nhap-theme" : "tra-theme");
            content.innerHTML = `<h4 class="fw-bold mb-3">${type}</h4><div id="items-list"></div>
                <button onclick="addRow('${theme}')" class="btn btn-outline-secondary w-100 mb-3">+ Th√™m m√≥n</button>
                <div class="card p-3 shadow-sm border-0">
                    <select id="p-method" class="form-select mb-3"><option value="Ti·ªÅn m·∫∑t">üíµ Ti·ªÅn m·∫∑t</option><option value="Chuy·ªÉn kho·∫£n">üè¶ Chuy·ªÉn kho·∫£n</option></select>
                    <div class="d-flex justify-content-between mb-3"><span class="fw-bold">T·ªîNG:</span><span id="total-bill" class="fs-4 fw-bold text-danger">0 ƒë</span></div>
                    <button id="btn-submit" onclick="submitOrder('${type}')" class="btn btn-lg w-100 fw-bold rounded-pill ${name==='ban-hang'?'btn-success':(name==='nhap-hang'?'btn-primary':'btn-danger')}">X√ÅC NH·∫¨N ${type.toUpperCase()}</button>
                </div>`;
            addRow(theme);
        } else if(name === 'lich-su') { renderHistory(); }
        else if(name === 'bao-cao-kho') { renderStock(); }
        else if(name === 'loi-nhuan') { renderFinance(); }
    }

    function addRow(theme) {
        const id = Date.now();
        const row = `<div class="order-row ${theme} row g-1" id="row-${id}">
            <div class="col-12 mb-1"><input list="plist" onchange="updateRow(${id}, this.value)" class="form-control" placeholder="T√™n s·∫£n ph·∫©m..."></div>
            <div class="col-4"><input type="number" id="q-${id}" onchange="calc()" class="form-control text-center" value="1"></div>
            <div class="col-6 text-end pt-1">
                <div class="stock-label" id="stock-${id}">Kho c√≤n: 0</div>
                <b class="fs-6" id="p-display-${id}">0 ƒë</b>
                <span id="p-raw-${id}" class="hidden">0</span>
            </div>
            <div class="col-2 text-center"><button onclick="this.parentElement.parentElement.remove();calc()" class="btn text-danger">‚úï</button></div>
        </div>`;
        document.getElementById('items-list').insertAdjacentHTML('beforeend', row);
        let d = document.getElementById('plist') || document.createElement('datalist');
        d.id = 'plist'; d.innerHTML = productList.map(p => `<option value="${p.ten}">`).join('');
        document.body.appendChild(d);
    }

    function updateRow(id, val) {
        const p = productList.find(x => x.ten === val);
        if(p) { 
            document.getElementById(`p-raw-${id}`).innerText = p.gia_ban; 
            document.getElementById(`p-display-${id}`).innerText = formatMoney(p.gia_ban);
            document.getElementById(`stock-${id}`).innerText = "Kho c√≤n: " + p.ton_kho;
            calc(); 
        }
    }

    function calc() {
        let t = 0;
        document.querySelectorAll('.order-row').forEach(r => {
            const id = r.id.split('-')[1];
            t += Number(document.getElementById(`p-raw-${id}`).innerText) * Number(document.getElementById(`q-${id}`).value);
        });
        document.getElementById('total-bill').innerText = formatMoney(t);
    }

    async function submitOrder(type) {
        const items = [];
        document.querySelectorAll('.order-row').forEach(r => {
            const id = r.id.split('-')[1], ten = r.querySelector('input').value, sl = Number(document.getElementById(`q-${id}`).value);
            if(ten) items.push({ten, sl, gia: Number(document.getElementById(`p-raw-${id}`).innerText)});
        });
        if(!items.length) return;
        
        document.getElementById('btn-submit').disabled = true;
        document.getElementById('btn-submit').innerHTML = `<span class="spinner-border spinner-border-sm"></span> ƒêang l∆∞u...`;

        try {
            await fetch(`${SCRIPT_URL}?action=saveOrder`, {method: 'POST', body: JSON.stringify({user: currentUser, type, method: document.getElementById('p-method').value, items})});
            Swal.fire({title: 'Th√†nh c√¥ng!', icon: 'success', timer: 1000, showConfirmButton: false});
            openTab(type === 'B√°n h√†ng' ? 'ban-hang' : (type === 'Nh·∫≠p h√†ng' ? 'nhap-hang' : 'tra-hang'));
            refreshProducts(); refreshHistory();
        } catch(e) {
            Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ l∆∞u ƒë∆°n', 'error');
            document.getElementById('btn-submit').disabled = false;
        }
    }

    async function renderFinance() {
        const now = new Date();
        const todayStr = now.toLocaleDateString('vi-VN');
        let dRev = 0, dProfit = 0, mRev = 0, mProfit = 0;
        
        historyData.forEach(x => {
            const d = new Date(x.thoigian);
            const amt = Number(x.thanhtien), l√£i = Number(x.loi_nhuan);
            if(d.toLocaleDateString('vi-VN') === todayStr) { dRev += amt; dProfit += l√£i; }
            if(d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear()) { mRev += amt; mProfit += l√£i; }
        });

        document.getElementById('main-content').innerHTML = `
            <h4 class="fw-bold mb-3" style="color:var(--tai-chinh)">üí∞ T√ÄI CH√çNH</h4>
            <div class="row g-2">
                <div class="col-6"><div class="stat-card shadow-sm"><small>D.Thu ng√†y</small><div class="stat-val text-primary">${formatMoney(dRev)}</div></div></div>
                <div class="col-6"><div class="stat-card shadow-sm"><small>L√£i ng√†y</small><div class="stat-val text-success">${formatMoney(dProfit)}</div></div></div>
                <div class="col-12"><div class="stat-card shadow-sm"><small>D.Thu th√°ng</small><div class="stat-val text-primary">${formatMoney(mRev)}</div></div></div>
                <div class="col-12"><div class="stat-card shadow-sm"><small>L√£i th√°ng</small><div class="stat-val text-success">${formatMoney(mProfit)}</div></div></div>
            </div>`;
    }

    async function renderHistory() {
        document.getElementById('main-content').innerHTML = `<h4 class="fw-bold mb-3">üìú Nh·∫≠t k√Ω</h4>` + 
            [...historyData].reverse().slice(0,10).map(x => `<div class="card p-2 mb-2 border-0 shadow-sm small">
                <div class="d-flex justify-content-between"><b>${x.madon}</b> <span>${x.pt_thanhtoan}</span></div>
                <div>${x.ten_sp} (x${x.sl})</div>
                <div class="text-end text-danger fw-bold">${formatMoney(x.thanhtien)}</div>
            </div>`).join('');
    }

    function renderStock() {
        document.getElementById('main-content').innerHTML = `<h4 class="fw-bold mb-3">üìä T·ªìn kho</h4>` + 
            productList.map(p => `<div class="card p-2 mb-1 border-0 shadow-sm d-flex flex-row justify-content-between"><span>${p.ten}</span><b>${p.ton_kho}</b></div>`).join('');
    }
</script>
</body>
</html>
