<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS Professional - V≈©ng T√†u Aquarium</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { --primary-color: #0d6efd; --bg-light: #f4f7f6; }
        body { background: var(--bg-light); font-family: 'Segoe UI', Roboto, sans-serif; }
        .hidden { display: none; }
        
        /* ƒêƒÉng nh·∫≠p chuy√™n nghi·ªáp */
        .login-card { border: none; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); background: #fff; overflow: hidden; }
        .login-header { background: linear-gradient(45deg, #0d6efd, #00d2ff); color: #fff; padding: 30px; }
        
        /* Dashboard & Content */
        .card { border: none; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .order-row { background: #fff; padding: 12px; border-radius: 10px; margin-bottom: 8px; border-left: 5px solid var(--primary-color); transition: 0.3s; }
        .order-row:hover { transform: translateX(5px); }
        
        /* Menu NgƒÉn k√©o */
        .menu-btn { font-size: 1.5rem; cursor: pointer; border: none; background: none; transition: 0.2s; }
        .menu-btn:hover { color: var(--primary-color); }
        .sidebar-btn { width: 100%; text-align: left; padding: 15px 25px; border: none; background: none; border-bottom: 1px solid #f0f0f0; transition: 0.3s; font-size: 1rem; color: #444; }
        .sidebar-btn:hover { background: #f8faff; color: var(--primary-color); padding-left: 35px; }
        
        /* Ti·ªán √≠ch */
        .time-display { font-size: 1.2rem; font-weight: bold; color: var(--primary-color); }
        .alert-item { background: #fff5f5; border-left: 4px solid #ff4d4f; padding: 10px; border-radius: 8px; margin-bottom: 5px; font-size: 0.9rem; }
    </style>
</head>
<body>

<div class="container py-5">
    <div id="login-box" class="row justify-content-center">
        <div class="col-md-5 col-lg-4">
            <div class="login-card">
                <div class="login-header text-center">
                    <h3 class="fw-bold m-0">ƒêƒÇNG NH·∫¨P</h3>
                    <p class="small m-0 opacity-75">H·ªá th·ªëng qu·∫£n l√Ω c√° c·∫£nh chuy√™n nghi·ªáp</p>
                </div>
                <div class="p-4">
                    <div class="mb-3">
                        <label class="form-label small fw-bold">T√†i kho·∫£n</label>
                        <input type="text" id="u" class="form-control form-control-lg" placeholder="Nh·∫≠p username...">
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">M·∫≠t kh·∫©u</label>
                        <input type="password" id="p" class="form-control form-control-lg" placeholder="Nh·∫≠p password...">
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="remember">
                            <label class="form-check-label small" for="remember">Ghi nh·ªõ t√¥i</label>
                        </div>
                    </div>
                    <button onclick="login()" class="btn btn-primary btn-lg w-100 fw-bold mb-2 shadow-sm">ƒêƒÇNG NH·∫¨P</button>
                    <div id="auto-login-area" class="hidden text-center">
                        <button onclick="autoLogin()" class="btn btn-outline-secondary btn-sm w-100">D√πng t√†i kho·∫£n ƒë√£ l∆∞u</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <header class="d-flex justify-content-between align-items-center mb-4 bg-white p-3 rounded-pill shadow-sm">
            <div class="d-flex align-items-center">
                <button class="menu-btn" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasMenu">‚ò∞</button>
                <span class="ms-2 small text-muted">Ch√†o, <b id="u-display" class="text-dark"></b></span>
            </div>
            <button onclick="location.reload()" class="btn btn-light btn-sm rounded-pill px-3">Tho√°t</button>
        </header>

        <div id="content" class="card p-4 min-vh-50">
            <div id="dashboard" class="text-center py-4">
                <div class="time-display mb-2" id="clock">ƒêang t·∫£i th·ªùi gian...</div>
                <div class="text-muted small mb-4" id="date-now"></div>
                <hr>
                <h6 class="text-start fw-bold text-danger mb-3">üî• C·∫¢NH B√ÅO S·∫ÆP H·∫æT H√ÄNG (D∆∞·ªõi 5 m√≥n)</h6>
                <div id="low-stock-list" class="text-start">
                    </div>
            </div>
        </div>
    </div>
</div>

<div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasMenu">
    <div class="offcanvas-header border-bottom">
        <h5 class="offcanvas-title fw-bold text-primary">DANH M·ª§C</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body p-0">
        <button class="sidebar-btn" onclick="handleMenuClick('ban-hang')">üõçÔ∏è B√°n H√†ng (Xu·∫•t)</button>
        <button class="sidebar-btn" onclick="handleMenuClick('nhap-hang')">üì¶ Nh·∫≠p H√†ng (C·ªông)</button>
        <button class="sidebar-btn text-danger fw-bold" onclick="handleMenuClick('tra-hang')">‚Ü©Ô∏è Kh√°ch Tr·∫£ H√†ng</button>
        <button class="sidebar-btn" onclick="handleMenuClick('lich-su')">üìú Nh·∫≠t K√Ω & X√≥a ƒê∆°n</button>
        <button class="sidebar-btn" onclick="handleMenuClick('bao-cao-kho')">üìä Xem B√°o C√°o Kho</button>
        <button id="admin-btn" class="sidebar-btn bg-warning-subtle text-danger fw-bold hidden" onclick="handleMenuClick('loi-nhuan')">üí∞ T√†i Ch√≠nh & L·ª£i Nhu·∫≠n</button>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx7quu8A47WBW2w4XWC3_sqDwez-E8FwB6UUigNGjBDAWFl9_lyp0MHSv2VRMF9a14TTQ/exec";
    let currentUser = "", currentRole = "", productList = [];

    // Ki·ªÉm tra th√¥ng tin ƒë√£ l∆∞u khi m·ªü App
    window.onload = function() {
        const savedU = localStorage.getItem('pos_user');
        if(savedU) {
            document.getElementById('auto-login-area').classList.remove('hidden');
            document.getElementById('u').value = savedU;
        }
        updateClock();
        setInterval(updateClock, 1000);
    };

    function updateClock() {
        const now = new Date();
        const timeStr = now.getHours().toString().padStart(2, '0') + ":" + 
                        now.getMinutes().toString().padStart(2, '0') + ":" + 
                        now.getSeconds().toString().padStart(2, '0');
        const dateStr = "Th·ª© " + (now.getDay() + 1) + ", ng√†y " + now.getDate() + " th√°ng " + (now.getMonth() + 1) + " nƒÉm " + now.getFullYear();
        if(document.getElementById('clock')) document.getElementById('clock').innerText = timeStr;
        if(document.getElementById('date-now')) document.getElementById('date-now').innerText = dateStr;
    }

    async function login() {
        const u = document.getElementById('u').value, p = document.getElementById('p').value;
        const remember = document.getElementById('remember').checked;
        
        Swal.fire({ title: 'ƒêang x√°c th·ª±c...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
        
        try {
            const res = await fetch(`${SCRIPT_URL}?action=login`, { method: 'POST', body: JSON.stringify({u, p}) }).then(r => r.json());
            Swal.close();
            if(res.status === 'success') {
                if(remember) localStorage.setItem('pos_user', u);
                currentUser = u; currentRole = res.role;
                initApp();
            } else { Swal.fire('L·ªói', 'Th√¥ng tin ƒëƒÉng nh·∫≠p sai!', 'error'); }
        } catch(e) { Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ k·∫øt n·ªëi Server!', 'error'); }
    }

    function autoLogin() {
        Swal.fire('Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u', '', 'info').then(() => {
            document.getElementById('p').focus();
        });
    }

    async function initApp() {
        document.getElementById('login-box').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
        document.getElementById('u-display').innerText = currentUser;
        if(currentRole === 'admin') document.getElementById('admin-btn').classList.remove('hidden');
        await loadProducts();
        renderDashboard();
    }

    async function loadProducts() { 
        productList = await fetch(`${SCRIPT_URL}?action=getProducts`).then(r => r.json()); 
    }

    function renderDashboard() {
        const listArea = document.getElementById('low-stock-list');
        listArea.innerHTML = "";
        const lowStock = productList.filter(p => p.ton_kho < 5);
        if(lowStock.length === 0) {
            listArea.innerHTML = "<p class='text-success small'>‚úÖ Kho h√†ng hi·ªán t·∫°i ƒëang ƒë·∫ßy ƒë·ªß.</p>";
        } else {
            lowStock.forEach(p => {
                listArea.innerHTML += `<div class="alert-item d-flex justify-content-between">
                    <span>${p.ten}</span>
                    <b class="text-danger">C√≤n: ${p.ton_kho}</b>
                </div>`;
            });
        }
    }

    function handleMenuClick(tabName) {
        bootstrap.Offcanvas.getInstance(document.getElementById('offcanvasMenu')).hide();
        showTab(tabName);
    }

    function showTab(name) {
        let content = document.getElementById('content');
        if(['ban-hang', 'nhap-hang', 'tra-hang'].includes(name)) {
            let type = name === 'ban-hang' ? "B√°n h√†ng" : (name === 'nhap-hang' ? "Nh·∫≠p h√†ng" : "Kh√°ch tr·∫£ h√†ng");
            content.innerHTML = `<h4 class="fw-bold mb-4">${type}</h4>
                <div id="items-list"></div>
                <button onclick="addRow()" class="btn btn-outline-primary btn-sm mb-3">+ Th√™m m√≥n</button>
                <div class="p-3 bg-light rounded-4 shadow-sm">
                    <div class="mb-3">
                        <label class="small fw-bold mb-2">Thanh to√°n:</label>
                        <div class="btn-group w-100">
                            <input type="radio" class="btn-check" name="method" id="m1" value="Ti·ªÅn m·∫∑t" checked>
                            <label class="btn btn-outline-secondary" for="m1">üíµ Ti·ªÅn m·∫∑t</label>
                            <input type="radio" class="btn-check" name="method" id="m2" value="Chuy·ªÉn kho·∫£n">
                            <label class="btn btn-outline-secondary" for="m2">üè¶ Bank</label>
                        </div>
                    </div>
                    <h5 class="text-end mb-3">T·ªïng c·ªông: <span id="total-bill" class="text-danger fw-bold fs-3">0</span> ƒë</h5>
                    <button onclick="sendOrder('${type}')" class="btn btn-primary btn-lg w-100 fw-bold rounded-pill">X√ÅC NH·∫¨N L∆ØU</button>
                </div>`;
            addRow();
        } 
        else if(name === 'lich-su') { loadHistory(); }
        else if(name === 'bao-cao-kho') { renderStockTable(); }
        else if(name === 'loi-nhuan') { loadFinanceReport(); }
    }

    function addRow() {
        const id = Date.now();
        const row = `<div class="order-row row g-2" id="row-${id}">
            <div class="col-7"><input list="plist" onchange="updateRow(${id}, this.value)" class="form-control" placeholder="T√™n sp..."></div>
            <div class="col-2"><input type="number" id="q-${id}" onchange="calcTotal()" class="form-control text-center" value="1"></div>
            <div class="col-2 text-end pt-2"><b id="p-${id}">0</b></div>
            <div class="col-1 text-center"><button onclick="this.parentElement.parentElement.remove();calcTotal()" class="btn text-danger">‚úï</button></div>
        </div>`;
        document.getElementById('items-list').insertAdjacentHTML('beforeend', row);
        updateDataList();
    }

    function updateRow(id, val) {
        const p = productList.find(x => x.ten === val);
        if(p) { document.getElementById(`p-${id}`).innerText = p.gia_ban; calcTotal(); }
    }

    function calcTotal() {
        let t = 0;
        document.querySelectorAll('.order-row').forEach(r => {
            const id = r.id.split('-')[1];
            t += Number(document.getElementById(`p-${id}`).innerText) * Number(document.getElementById(`q-${id}`).value);
        });
        document.getElementById('total-bill').innerText = t.toLocaleString();
    }

    async function sendOrder(type) {
        const method = document.querySelector('input[name="method"]:checked').value;
        const items = [];
        document.querySelectorAll('.order-row').forEach(r => {
            const id = r.id.split('-')[1], ten = r.querySelector('input').value.trim(), sl = Number(document.getElementById(`q-${id}`).value);
            if(ten) items.push({ ten, sl, gia: Number(document.getElementById(`p-${id}`).innerText) });
        });
        if(items.length === 0) return;
        
        Swal.fire({ title: 'ƒêang l∆∞u...', didOpen: () => Swal.showLoading() });
        await fetch(`${SCRIPT_URL}?action=saveOrder`, { method: 'POST', body: JSON.stringify({user: currentUser, type, method, items}) });
        await loadProducts();
        Swal.fire('Th√†nh c√¥ng!', '', 'success');
        showTab(name === 'B√°n h√†ng' ? 'ban-hang' : (name === 'Nh·∫≠p h√†ng' ? 'nhap-hang' : 'tra-hang'));
    }

    function renderStockTable() {
        let html = `<h4 class="fw-bold mb-3">üì¶ B√°o C√°o T·ªìn Kho</h4>
                    <input type="text" id="stock-search" class="form-control mb-3" placeholder="T√¨m nhanh s·∫£n ph·∫©m..." onkeyup="filterStock()">
                    <div class="stock-table-container">
                        <table class="table table-hover border">
                            <thead class="table-light sticky-top"><tr><th>T√™n</th><th>T·ªìn</th></tr></thead>
                            <tbody id="stock-body">`;
        productList.forEach(p => {
            const lowClass = p.ton_kho < 5 ? 'low-stock' : '';
            html += `<tr><td>${p.ten}</td><td class="${lowClass}">${p.ton_kho}</td></tr>`;
        });
        html += `</tbody></table></div>`;
        document.getElementById('content').innerHTML = html;
    }

    function filterStock() {
        let val = document.getElementById('stock-search').value.toLowerCase();
        let rows = document.getElementById('stock-body').getElementsByTagName('tr');
        for (let row of rows) {
            row.style.display = row.cells[0].innerText.toLowerCase().includes(val) ? "" : "none";
        }
    }

    async function loadHistory() {
        const hist = await fetch(`${SCRIPT_URL}?action=getHistory`).then(r => r.json());
        let h = `<h4 class="fw-bold mb-3">üìú Nh·∫≠t K√Ω</h4><table class="table table-sm"><thead><tr><th>ƒê∆°n</th><th>Ti·ªÅn</th><th></th></tr></thead><tbody>`;
        hist.reverse().slice(0, 15).forEach((x, i) => {
            h += `<tr><td><small>${x.madon}</small></td><td>${Number(x.thanhtien).toLocaleString()}</td>
            <td><button onclick="deleteRow(${hist.length - i})" class="btn text-danger p-0">üóëÔ∏è</button></td></tr>`;
        });
        document.getElementById('content').innerHTML = h + `</tbody></table>`;
    }

    async function deleteRow(idx) {
        const res = await Swal.fire({ title: 'X√≥a ƒë∆°n n√†y?', icon: 'warning', showCancelButton: true });
        if(res.isConfirmed) {
            Swal.showLoading();
            await fetch(`${SCRIPT_URL}?action=deleteOrder`, { method: 'POST', body: JSON.stringify({row: idx + 1}) });
            await loadProducts();
            loadHistory();
            Swal.fire('ƒê√£ x√≥a!', '', 'success');
        }
    }

    async function loadFinanceReport() {
        const hist = await fetch(`${SCRIPT_URL}?action=getHistory`).then(r => r.json());
        let dCash = 0, dBank = 0, mProfit = 0;
        const now = new Date();
        hist.forEach(x => {
            const d = new Date(x.thoigian);
            if(d.toDateString() === now.toDateString()) {
                if(x.pt_thanhtoan === "Ti·ªÅn m·∫∑t") dCash += Number(x.thanhtien);
                else dBank += Number(x.thanhtien);
            }
            if(d.getMonth() === now.getMonth()) mProfit += Number(x.loi_nhuan);
        });
        document.getElementById('content').innerHTML = `<h4>üí∞ T√†i Ch√≠nh</h4>
            <div class="row g-2 mb-3">
                <div class="col-6"><div class="card p-3 bg-primary text-white">M·∫∑t:<br><b>${dCash.toLocaleString()}</b></div></div>
                <div class="col-6"><div class="card p-3 bg-info text-white">Bank:<br><b>${dBank.toLocaleString()}</b></div></div>
            </div>
            <div class="card p-3 bg-success text-white text-center"><h5>L√£i Th√°ng: ${mProfit.toLocaleString()} ƒë</h5></div>`;
    }

    function updateDataList() {
        let dl = document.getElementById('plist') || document.createElement('datalist');
        dl.id = 'plist'; dl.innerHTML = productList.map(p => `<option value="${p.ten}">`).join('');
        document.body.appendChild(dl);
    }
</script>
</body>
</html>
