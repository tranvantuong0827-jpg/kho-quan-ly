<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS Master v1 - Kho Qu·∫£n L√Ω</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
        .hidden { display: none; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .order-row { background: #fff; padding: 10px; border-radius: 8px; margin-bottom: 8px; border-left: 5px solid #0d6efd; }
        .stock-table-container { max-height: 500px; overflow-y: auto; }
        .low-stock { color: red; font-weight: bold; }
        /* Style cho Menu 3 g·∫°ch */
        .menu-btn { font-size: 1.5rem; cursor: pointer; border: none; background: none; padding: 0 10px; }
        .sidebar-btn { width: 100%; text-align: left; padding: 15px; border: none; background: none; border-bottom: 1px solid #eee; transition: 0.2s; font-size: 1.1rem; }
        .sidebar-btn:hover { background: #e7f3ff; color: #0d6efd; }
    </style>
</head>
<body>

<div class="container py-4">
    <div id="login-box" class="row justify-content-center mt-5">
        <div class="col-md-4 card p-4 text-center">
            <h3 class="text-primary fw-bold mb-4">H·ªÜ TH·ªêNG POS V1</h3>
            <input type="text" id="u" class="form-control mb-2" placeholder="T√™n ƒëƒÉng nh·∫≠p">
            <input type="password" id="p" class="form-control mb-4" placeholder="M·∫≠t kh·∫©u">
            <button onclick="login()" class="btn btn-primary w-100 py-2 fw-bold">V√ÄO H·ªÜ TH·ªêNG</button>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <header class="d-flex justify-content-between align-items-center mb-4 bg-white p-3 rounded shadow-sm">
            <div class="d-flex align-items-center">
                <button class="menu-btn" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasMenu">
                    ‚ò∞
                </button>
                <span class="ms-2">üë§ Nh√¢n vi√™n: <b id="u-display"></b></span>
            </div>
            <button onclick="location.reload()" class="btn btn-outline-danger btn-sm">Tho√°t</button>
        </header>

        <div class="row">
            <div class="col-12">
                <div id="content" class="card p-4 min-vh-50">
                    <div class="text-center py-5 text-muted">B·∫•m n√∫t ‚ò∞ ·ªü tr√™n ƒë·ªÉ ch·ªçn ch·ª©c nƒÉng</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasMenu" aria-labelledby="offcanvasMenuLabel">
    <div class="offcanvas-header bg-primary text-white">
        <h5 class="offcanvas-title" id="offcanvasMenuLabel">DANH M·ª§C CH·ª®C NƒÇNG</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body p-0">
        <button class="sidebar-btn" onclick="handleMenuClick('ban-hang')">üõçÔ∏è B√°n H√†ng (Xu·∫•t)</button>
        <button class="sidebar-btn" onclick="handleMenuClick('nhap-hang')">üì¶ Nh·∫≠p H√†ng (C·ªông)</button>
        <button class="sidebar-btn text-danger fw-bold" onclick="handleMenuClick('tra-hang')">‚Ü©Ô∏è Kh√°ch Tr·∫£ H√†ng</button>
        <button class="sidebar-btn" onclick="handleMenuClick('lich-su')">üìú Nh·∫≠t K√Ω & X√≥a ƒê∆°n</button>
        <button class="sidebar-btn bg-info-subtle fw-bold" onclick="handleMenuClick('bao-cao-kho')">üìä Xem B√°o C√°o Kho</button>
        <button id="admin-btn" class="sidebar-btn bg-warning-subtle text-danger fw-bold hidden" onclick="handleMenuClick('loi-nhuan')">üí∞ T√†i Ch√≠nh & L·ª£i Nhu·∫≠n</button>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx7quu8A47WBW2w4XWC3_sqDwez-E8FwB6UUigNGjBDAWFl9_lyp0MHSv2VRMF9a14TTQ/exec";
    let currentUser = "", currentRole = "", productList = [];

    // H√†m ƒë√≥ng menu sau khi ch·ªçn m√≥n (cho g·ªçn)
    function handleMenuClick(tabName) {
        const offcanvasElement = document.getElementById('offcanvasMenu');
        const instance = bootstrap.Offcanvas.getInstance(offcanvasElement);
        if (instance) instance.hide();
        showTab(tabName);
    }

    async function login() {
        const u = document.getElementById('u').value, p = document.getElementById('p').value;
        Swal.showLoading();
        const res = await fetch(`${SCRIPT_URL}?action=login`, { method: 'POST', body: JSON.stringify({u, p}) }).then(r => r.json());
        Swal.close();
        if(res.status === 'success') {
            currentUser = u; currentRole = res.role;
            document.getElementById('login-box').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('u-display').innerText = u;
            if(res.role === 'admin') document.getElementById('admin-btn').classList.remove('hidden');
            await loadProducts();
        } else { Swal.fire('L·ªói', 'Sai th√¥ng tin ƒëƒÉng nh·∫≠p!', 'error'); }
    }

    async function loadProducts() { 
        productList = await fetch(`${SCRIPT_URL}?action=getProducts`).then(r => r.json()); 
    }

    function showTab(name) {
        if(['ban-hang', 'nhap-hang', 'tra-hang'].includes(name)) {
            let type = name === 'ban-hang' ? "B√°n h√†ng" : (name === 'nhap-hang' ? "Nh·∫≠p h√†ng" : "Kh√°ch tr·∫£ h√†ng");
            document.getElementById('content').innerHTML = `<h4>${type}</h4>
                <div id="items-list"></div>
                <button onclick="addRow()" class="btn btn-outline-primary btn-sm mb-3">+ Th√™m M√≥n</button>
                <div class="p-3 bg-light rounded shadow-sm">
                    <div class="mb-3">
                        <label class="fw-bold mb-2 d-block">Thanh to√°n:</label>
                        <div class="btn-group w-100">
                            <input type="radio" class="btn-check" name="method" id="m1" value="Ti·ªÅn m·∫∑t" checked>
                            <label class="btn btn-outline-secondary" for="m1">üíµ Ti·ªÅn m·∫∑t</label>
                            <input type="radio" class="btn-check" name="method" id="m2" value="Chuy·ªÉn kho·∫£n">
                            <label class="btn btn-outline-secondary" for="m2">üè¶ Bank</label>
                        </div>
                    </div>
                    <h5 class="text-end">T·ªïng: <span id="total-bill" class="text-danger fw-bold">0</span> ƒë</h5>
                    <button onclick="sendOrder('${type}')" class="btn btn-primary w-100 btn-lg mt-2 fw-bold">X√ÅC NH·∫¨N L∆ØU</button>
                </div>`;
            addRow();
        } 
        else if(name === 'lich-su') { loadHistory(); }
        else if(name === 'bao-cao-kho') { renderStockTable(); }
        else if(name === 'loi-nhuan') { loadFinanceReport(); }
    }

    function addRow() {
        const id = Date.now();
        const row = `<div class="order-row row g-2" id="row-${id}">
            <div class="col-7"><input list="plist" onchange="updateRow(${id}, this.value)" class="form-control" placeholder="T√™n sp..."></div>
            <div class="col-2"><input type="number" id="q-${id}" onchange="calcTotal()" class="form-control text-center" value="1" min="1"></div>
            <div class="col-2 text-end"><b id="p-${id}">0</b></div>
            <div class="col-1 text-center"><button onclick="this.parentElement.parentElement.remove();calcTotal()" class="btn text-danger">‚úï</button></div>
        </div>`;
        document.getElementById('content').querySelector('#items-list').insertAdjacentHTML('beforeend', row);
        updateDataList();
    }

    function updateRow(id, val) {
        const p = productList.find(x => x.ten === val);
        if(p) { document.getElementById(`p-${id}`).innerText = p.gia_ban; calcTotal(); }
    }

    function calcTotal() {
        let t = 0;
        document.querySelectorAll('.order-row').forEach(r => {
            const id = r.id.split('-')[1];
            t += Number(document.getElementById(`p-${id}`).innerText) * Number(document.getElementById(`q-${id}`).value);
        });
        document.getElementById('total-bill').innerText = t.toLocaleString();
    }

    async function sendOrder(type) {
        const method = document.querySelector('input[name="method"]:checked').value;
        const items = [];
        document.querySelectorAll('.order-row').forEach(r => {
            const id = r.id.split('-')[1], ten = r.querySelector('input').value.trim(), sl = Number(document.getElementById(`q-${id}`).value);
            if(ten) items.push({ ten, sl, gia: Number(document.getElementById(`p-${id}`).innerText) });
        });
        if(items.length === 0) return;
        Swal.showLoading();
        await fetch(`${SCRIPT_URL}?action=saveOrder`, { method: 'POST', body: JSON.stringify({user: currentUser, type, method, items}) });
        await loadProducts();
        Swal.fire('Th√†nh c√¥ng!', '', 'success');
        showTab(type === 'B√°n h√†ng' ? 'ban-hang' : (type === 'Nh·∫≠p h√†ng' ? 'nhap-hang' : 'tra-hang')); 
    }

    function renderStockTable() {
        let html = `<h4>üì¶ B√°o C√°o T·ªìn Kho</h4>
                    <input type="text" id="stock-search" class="form-control mb-3" placeholder="T√¨m s·∫£n ph·∫©m..." onkeyup="filterStock()">
                    <div class="stock-table-container">
                        <table class="table table-bordered table-striped">
                            <thead class="table-dark sticky-top">
                                <tr><th>T√™n</th><th>T·ªìn</th></tr>
                            </thead>
                            <tbody id="stock-body">`;
        productList.forEach(p => {
            const lowClass = p.ton_kho < 5 ? 'low-stock' : '';
            html += `<tr><td>${p.ten}</td><td class="${lowClass}">${p.ton_kho}</td></tr>`;
        });
        html += `</tbody></table></div>`;
        document.getElementById('content').innerHTML = html;
    }

    function filterStock() {
        let val = document.getElementById('stock-search').value.toLowerCase();
        let rows = document.getElementById('stock-body').getElementsByTagName('tr');
        for (let row of rows) {
            let text = row.cells[0].innerText.toLowerCase();
            row.style.display = text.includes(val) ? "" : "none";
        }
    }

    async function loadHistory() {
        const hist = await fetch(`${SCRIPT_URL}?action=getHistory`).then(r => r.json());
        let h = `<h4>üìú Nh·∫≠t K√Ω</h4><table class="table table-sm"><thead><tr><th>M√£</th><th>M√≥n</th><th>Ti·ªÅn</th><th></th></tr></thead><tbody>`;
        hist.reverse().slice(0, 15).forEach((x, i) => {
            h += `<tr><td><small>${x.madon}</small></td><td>${x.ten_sp}</td><td>${Number(x.thanhtien).toLocaleString()}</td>
            <td><button onclick="deleteRow(${hist.length - i})" class="btn text-danger p-0">üóëÔ∏è</button></td></tr>`;
        });
        document.getElementById('content').innerHTML = h + `</tbody></table>`;
    }

    async function deleteRow(idx) {
        const res = await Swal.fire({ title: 'X√≥a ƒë∆°n?', icon: 'warning', showCancelButton: true });
        if(res.isConfirmed) {
            Swal.showLoading();
            await fetch(`${SCRIPT_URL}?action=deleteOrder`, { method: 'POST', body: JSON.stringify({row: idx + 1}) });
            await loadProducts();
            loadHistory();
            Swal.fire('ƒê√£ x√≥a!', '', 'success');
        }
    }

    async function loadFinanceReport() {
        const hist = await fetch(`${SCRIPT_URL}?action=getHistory`).then(r => r.json());
        let dCash = 0, dBank = 0, mProfit = 0;
        const now = new Date();
        hist.forEach(x => {
            const d = new Date(x.thoigian);
            if(d.toDateString() === now.toDateString()) {
                if(x.pt_thanhtoan === "Ti·ªÅn m·∫∑t") dCash += Number(x.thanhtien);
                else dBank += Number(x.thanhtien);
            }
            if(d.getMonth() === now.getMonth()) mProfit += Number(x.loi_nhuan);
        });
        document.getElementById('content').innerHTML = `<h4>üí∞ T√†i Ch√≠nh</h4>
            <div class="row g-2 mb-3">
                <div class="col-6"><div class="card p-3 bg-primary text-white">Ng√†y (M·∫∑t):<br><b>${dCash.toLocaleString()}</b></div></div>
                <div class="col-6"><div class="card p-3 bg-info text-white">Ng√†y (Bank):<br><b>${dBank.toLocaleString()}</b></div></div>
            </div>
            <div class="card p-3 bg-success text-white text-center"><h5>L√£i Th√°ng: ${mProfit.toLocaleString()} ƒë</h5></div>`;
    }

    function updateDataList() {
        let dl = document.getElementById('plist') || document.createElement('datalist');
        dl.id = 'plist'; dl.innerHTML = productList.map(p => `<option value="${p.ten}">`).join('');
        document.body.appendChild(dl);
    }
</script>
</body>
</html>
